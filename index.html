<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RCM Permanent Tracker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --primary-color: #000080;
            --saffron: #FF9933;
            --white: #FFFFFF;
            --green: #138808;
            --bg-color: #f4f6f9;
        }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg-color); margin: 0; padding: 10px; color: #333; }
        .container { max-width: 700px; margin: 0 auto; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }

        /* Flag Header */
        .flag-header {
            background: linear-gradient(135deg, #FF9933, #FFFFFF, #138808);
            padding: 30px; text-align: center; border-radius: 15px; margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); border: 1px solid #ddd;
        }
        .header-title { color: #000080; font-size: 2rem; font-weight: 900; margin: 0; text-shadow: 1px 1px 0 #fff; text-transform: uppercase; }
        .header-sub { background: #000080; color: white; padding: 5px 15px; border-radius: 20px; font-weight: bold; font-size: 0.9rem; margin-top: 5px; display: inline-block; }

        /* Sections */
        .section { background: #fff; border: 1px solid #ddd; border-radius: 10px; padding: 15px; margin-bottom: 15px; border-left: 5px solid var(--primary-color); }
        .sec-title { font-weight: bold; color: var(--primary-color); margin-bottom: 10px; display: flex; align-items: center; font-size: 1.1rem; }
        .sec-icon { background: #eee; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%; margin-right: 10px; }

        /* Inputs */
        .row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px dashed #eee; }
        .row:last-child { border-bottom: none; }
        .inp-num { width: 80px; padding: 5px; border: 1px solid #ccc; border-radius: 5px; text-align: center; font-weight: bold; color: #000080; }
        .inp-check { width: 20px; height: 20px; margin-right: 10px; }
        
        /* Business Stats */
        .biz-box { background: #fff8e1; border: 2px solid #ffc107; padding: 15px; border-radius: 10px; margin-bottom: 20px; }
        .biz-row { display: grid; grid-template-columns: 1.5fr 1fr 1fr 1fr; gap: 5px; align-items: center; margin-bottom: 5px; font-size: 0.9rem; }
        .growth-val { font-weight: bold; text-align: center; font-size: 0.8rem; }
        .pos { color: green; } .neg { color: red; }

        /* Buttons */
        .btn { width: 100%; padding: 12px; border: none; border-radius: 50px; font-weight: bold; color: white; cursor: pointer; margin-top: 10px; font-size: 1rem; }
        .btn-save { background: #2e7d32; }
        .btn-wa { background: #25D366; }
        .btn-pdf { background: #d32f2f; }
        .btn-load { background: #000080; width: auto; padding: 8px 20px; margin-left: 10px; }

        .date-box { text-align: center; margin-bottom: 15px; padding: 10px; background: #e3f2fd; border-radius: 10px; }
        #statusMsg { text-align: center; font-weight: bold; margin: 10px 0; font-size: 0.9rem; }
    </style>
</head>
<body>

<div class="container" id="reportContent">
    
    <div class="flag-header">
        <h1 class="header-title">üáÆüá≥ GASES ‡§ó‡•Å‡§∞‡•Å‡§Æ‡§Ç‡§§‡•ç‡§∞ üáÆüá≥</h1>
        <div class="header-sub">RCM Permanent Data Tracker</div>
    </div>

    <div class="date-box" data-html2canvas-ignore="true">
        <label><b>‡§§‡§æ‡§∞‡•Ä‡§ñ (Date):</b></label>
        <input type="date" id="reportDate" style="padding: 6px; font-weight: bold;">
        <button class="btn btn-load" onclick="window.loadFromFirebase()">üîÑ ‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§æ</button>
    </div>
    <div id="statusMsg">Loading system...</div>

    <div class="biz-box">
        <div style="text-align:center; font-weight:bold; color:#e65100; margin-bottom:10px;">üìä ‡§¨‡§ø‡§ù‡§®‡•á‡§∏ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü (Business)</div>
        <div class="biz-row" style="font-weight:bold; color:#555;">
            <div>Type</div> <div>Today</div> <div>Yest</div> <div>Growth</div>
        </div>
        <div class="biz-row">
            <div>Total PV</div>
            <input type="number" id="totalToday" class="inp-num" placeholder="0" oninput="calcGrowth()">
            <input type="number" id="totalYest" class="inp-num" placeholder="0" readonly style="background:#eee;">
            <div id="gTotal" class="growth-val">-</div>
        </div>
        <div class="biz-row">
            <div style="color:green;">Leg A</div>
            <input type="number" id="legAToday" class="inp-num" placeholder="0" oninput="calcGrowth()">
            <input type="number" id="legAYest" class="inp-num" placeholder="0" readonly style="background:#eee;">
            <div id="gLegA" class="growth-val">-</div>
        </div>
        <div class="biz-row">
            <div style="color:#d32f2f;">Leg B</div>
            <input type="number" id="legBToday" class="inp-num" placeholder="0" oninput="calcGrowth()">
            <input type="number" id="legBYest" class="inp-num" placeholder="0" readonly style="background:#eee;">
            <div id="gLegB" class="growth-val">-</div>
        </div>
    </div>

    <form id="trackerForm">
        <div class="section">
            <div class="sec-title"><div class="sec-icon">G</div> ‡§ó‡•ç‡§∞‡•ã‡§• (Growth)</div>
            <div class="row"><span>‡§Æ‡§π‡§ø‡§®‡•ç‡§Ø‡§æ‡§ö‡•á ‡§ü‡§æ‡§∞‡•ç‡§ó‡•á‡§ü</span> <select id="target" style="padding:5px;"><option>Normal</option><option>25%</option><option>50%</option><option>100%</option></select></div>
            <div class="row"><span>‡§™‡•ç‡§≤‡§æ‡§® ‡§∂‡•ã (‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ)</span> <input type="number" id="plans" class="inp-num" placeholder="0"></div>
            <div class="row"><span>‡§®‡§µ‡•Ä‡§® Vital ‡§ï‡§æ‡§Æ</span> <input type="checkbox" id="g_vital" class="inp-check"></div>
            <div class="row"><span>‡§®‡§µ‡•Ä‡§® ‡§ï‡•á‡§Ç‡§¶‡•ç‡§∞ / ‡§°‡§ø‡§∏‡•ç‡§™‡•ç‡§≤‡•á ‡§µ‡•â‡§≤</span> <input type="checkbox" id="g_display" class="inp-check"></div>
        </div>

        <div class="section">
            <div class="sec-title"><div class="sec-icon">A</div> ‡§è‡§ï‡•ç‡§ü‡§ø‡§µ (Active)</div>
            <div class="row"><span>‡§ï‡•â‡§≤‡§ø‡§Ç‡§ó (Calls)</span> <input type="number" id="calls" class="inp-num" placeholder="0"></div>
            <div class="row"><span>‡§Æ‡•Ä‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏</span> <input type="number" id="meetings" class="inp-num" placeholder="0"></div>
            <div class="row"><span>ULP ‡§ö‡•á‡§ï ‡§ï‡•á‡§≤‡•Ä</span> <input type="checkbox" id="a_ulp" class="inp-check"></div>
            <div class="row"><span>Zero ID ‡§è‡§ï‡•ç‡§ü‡§ø‡§µ‡•á‡§∂‡§®</span> <input type="checkbox" id="a_zero" class="inp-check"></div>
        </div>

        <div class="section">
            <div class="sec-title"><div class="sec-icon">S</div> ‡§ñ‡§∞‡•á‡§¶‡•Ä (Self Purchase)</div>
            <div class="row"><span>‡§∏‡•á‡§≤‡•ç‡§´ PV (‚Çπ)</span> <input type="number" id="pv" class="inp-num" placeholder="‚Çπ"></div>
            <div class="row"><span>‡§°‡§æ‡§Ø‡§Æ‡§Ç‡§° ‡§ï‡•ç‡§≤‡§¨</span> <input type="checkbox" id="s_diamond" class="inp-check"></div>
            <div class="row"><span>‡§¨‡§ø‡§≤‡§ø‡§Ç‡§ó ‡§ï‡•á‡§≤‡•á (Billing)</span> <input type="checkbox" id="s_billing" class="inp-check"></div>
        </div>

        <div class="section">
            <div class="sec-title"><div class="sec-icon">E</div> ‡§∂‡§ø‡§ï‡•ç‡§∑‡§£ (Education)</div>
            <div class="row"><span>‡§ó‡•Å‡§∞‡•Å‡§ï‡•Å‡§≤ / ‡§µ‡•ç‡§π‡§ø‡§°‡§ø‡§ì</span> <input type="checkbox" id="e_learn" class="inp-check"></div>
            <div class="row"><span>‡§™‡•Å‡§∏‡•ç‡§§‡§ï ‡§µ‡§æ‡§ö‡§®</span> <input type="checkbox" id="e_book" class="inp-check"></div>
            <div class="row"><span>‡§ü‡•Ä‡§Æ ‡§ü‡•ç‡§∞‡•á‡§®‡§ø‡§Ç‡§ó</span> <input type="checkbox" id="e_teach" class="inp-check"></div>
        </div>

        <div class="section">
            <div class="sec-title"><div class="sec-icon">S</div> ‡§∏‡•ã‡§∂‡§≤ (Social)</div>
            <div class="row"><span>‡§∏‡§Ç‡§¨‡§Ç‡§ß (Relationship)</span> <input type="checkbox" id="so_relation" class="inp-check"></div>
            <div class="row"><span>‡§Æ‡§æ‡§´‡•Ä / ‡§∞‡§æ‡§ó ‡§∏‡•ã‡§°‡§≤‡§æ</span> <input type="checkbox" id="so_forgive" class="inp-check"></div>
        </div>

        <div class="section" style="border-left-color: #ff6f00;">
            <div class="sec-title" style="color:#ff6f00;"><div class="sec-icon">üìù</div> ‡§â‡§¶‡•ç‡§Ø‡§æ‡§ö‡•á ‡§®‡§ø‡§Ø‡•ã‡§ú‡§®</div>
            <div id="planContainer"></div>
            <button type="button" onclick="addPlan()" style="background:#ff6f00; color:white; border:none; padding:5px 15px; border-radius:15px; cursor:pointer; margin-top:5px;">+ ‡§ï‡§æ‡§Æ ‡•≤‡§° ‡§ï‡§∞‡§æ</button>
        </div>
        
        <div id="analysisBox" style="display:none; background:#e0f2f1; padding:15px; border-radius:10px; border:1px solid #00695c; margin-top:15px;">
            <h3 style="margin:0 0 10px 0; color:#00695c;">ü§ñ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ (Analysis)</h3>
            <div id="analysisText"></div>
        </div>

    </form>
</div>

<div class="container" style="background:transparent; box-shadow:none; margin-top:0;">
    <button class="btn btn-save" onclick="window.saveToFirebase()">‚òÅÔ∏è ‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä ‡§∏‡•á‡§µ‡•ç‡§π ‡§ï‡§∞‡§æ (Save Data)</button>
    <button class="btn btn-wa" onclick="shareWA()">üì≤ WhatsApp ‡§µ‡§∞ ‡§™‡§æ‡§†‡§µ‡§æ</button>
    <button class="btn btn-pdf" onclick="dlPDF()">üì• PDF ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü</button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCsgwBoTiEtSNJ2xMm4di0F0GiAtFxoswM",
    authDomain: "order-b15a8.firebaseapp.com",
    projectId: "order-b15a8",
    storageBucket: "order-b15a8.firebasestorage.app",
    messagingSenderId: "614443594278",
    appId: "1:614443594278:web:e31715b6ee592b30326ce7"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const dateInput = document.getElementById('reportDate');
  const statusMsg = document.getElementById('statusMsg');
  
  dateInput.valueAsDate = new Date();

  // Load on Start
  window.onload = function() { window.loadFromFirebase(); };

  // SAVE
  window.saveToFirebase = async function() {
    const dateVal = dateInput.value;
    if(!dateVal) { alert("‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§®‡§ø‡§µ‡§°‡§æ!"); return; }
    statusMsg.innerText = "‚è≥ Saving...";
    statusMsg.style.color = "blue";

    // Collect Plans
    let plans = [];
    document.querySelectorAll('.dyn-plan').forEach(el => { if(el.value) plans.push(el.value); });

    const data = {
        totalToday: val('totalToday'), legAToday: val('legAToday'), legBToday: val('legBToday'),
        target: val('target', false), plans: val('plans'),
        g_vital: chk('g_vital'), g_display: chk('g_display'),
        calls: val('calls'), meetings: val('meetings'),
        a_ulp: chk('a_ulp'), a_zero: chk('a_zero'),
        pv: val('pv'), s_diamond: chk('s_diamond'), s_billing: chk('s_billing'),
        e_learn: chk('e_learn'), e_book: chk('e_book'), e_teach: chk('e_teach'),
        so_relation: chk('so_relation'), so_forgive: chk('so_forgive'),
        planList: plans,
        timestamp: new Date()
    };

    try {
        await setDoc(doc(db, "rcm_permanent_data", dateVal), data);
        statusMsg.innerText = "‚úÖ Data Saved Successfully!";
        statusMsg.style.color = "green";
        alert("‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä ‡§Ø‡§∂‡§∏‡•ç‡§µ‡•Ä‡§∞‡§ø‡§§‡•ç‡§Ø‡§æ ‡§∏‡•á‡§µ‡•ç‡§π ‡§ù‡§æ‡§≤‡•Ä!");
        genAnalysis();
    } catch (e) {
        statusMsg.innerText = "‚ùå Save Failed: " + e.message;
        statusMsg.style.color = "red";
        alert("Error: " + e.message);
    }
  }

  // LOAD
  window.loadFromFirebase = async function() {
    const dateVal = dateInput.value;
    if(!dateVal) return;
    statusMsg.innerText = "‚è≥ Loading Data...";
    statusMsg.style.color = "blue";
    
    // Previous Day
    const prevDate = new Date(dateVal);
    prevDate.setDate(prevDate.getDate() - 1);
    const yestVal = prevDate.toISOString().split('T')[0];

    try {
        // Load Today
        const docRef = doc(db, "rcm_permanent_data", dateVal);
        const snap = await getDoc(docRef);
        
        document.getElementById('planContainer').innerHTML = ""; // Clear plans

        if(snap.exists()) {
            const d = snap.data();
            setVal('totalToday', d.totalToday); setVal('legAToday', d.legAToday); setVal('legBToday', d.legBToday);
            document.getElementById('target').value = d.target || "Normal";
            setVal('plans', d.plans); setChk('g_vital', d.g_vital); setChk('g_display', d.g_display);
            setVal('calls', d.calls); setVal('meetings', d.meetings); setChk('a_ulp', d.a_ulp); setChk('a_zero', d.a_zero);
            setVal('pv', d.pv); setChk('s_diamond', d.s_diamond); setChk('s_billing', d.s_billing);
            setChk('e_learn', d.e_learn); setChk('e_book', d.e_book); setChk('e_teach', d.e_teach);
            setChk('so_relation', d.so_relation); setChk('so_forgive', d.so_forgive);
            
            if(d.planList && d.planList.length) d.planList.forEach(t => addPlan(t));
            else addPlan();

            statusMsg.innerText = "‚úÖ Data Loaded!";
            statusMsg.style.color = "green";
            genAnalysis();
        } else {
            document.getElementById('trackerForm').reset();
            addPlan();
            statusMsg.innerText = "‚ö†Ô∏è No data for this date.";
            statusMsg.style.color = "orange";
        }

        // Load Yesterday
        const ySnap = await getDoc(doc(db, "rcm_permanent_data", yestVal));
        if(ySnap.exists()) {
            setVal('totalYest', ySnap.data().totalToday);
            setVal('legAYest', ySnap.data().legAToday);
            setVal('legBYest', ySnap.data().legBToday);
        } else {
            setVal('totalYest', 0); setVal('legAYest', 0); setVal('legBYest', 0);
        }
        window.calcGrowth();

    } catch (e) {
        statusMsg.innerText = "‚ùå Load Error: " + e.message;
        statusMsg.style.color = "red";
    }
  }

  // Helpers
  function val(id, isNum=true) { return isNum ? (document.getElementById(id).value || "") : document.getElementById(id).value; }
  function chk(id) { return document.getElementById(id).checked; }
  function setVal(id, v) { document.getElementById(id).value = v || ""; }
  function setChk(id, v) { document.getElementById(id).checked = v || false; }

  // Expose to window
  window.loadFromFirebase = window.loadFromFirebase;
  document.getElementById('reportDate').addEventListener('change', window.loadFromFirebase);
</script>

<script>
    // --- UI Logic ---
    function addPlan(txt = "") {
        const div = document.createElement('div');
        div.style.marginBottom = "5px";
        div.innerHTML = `<input type="text" class="dyn-plan" value="${txt}" style="width:85%; padding:8px; border:1px solid #ccc; border-radius:5px;" placeholder="Task..."> <span onclick="this.parentElement.remove()" style="color:red; cursor:pointer; font-weight:bold;">X</span>`;
        document.getElementById('planContainer').appendChild(div);
    }

    window.calcGrowth = function() {
        doCalc('totalToday', 'totalYest', 'gTotal');
        doCalc('legAToday', 'legAYest', 'gLegA');
        doCalc('legBToday', 'legBYest', 'gLegB');
    }

    function doCalc(t, y, r) {
        let T = parseFloat(document.getElementById(t).value)||0;
        let Y = parseFloat(document.getElementById(y).value)||0;
        let el = document.getElementById(r);
        let d = T-Y;
        let p = Y > 0 ? ((d/Y)*100).toFixed(1) + "%" : "";
        el.innerHTML = `<span class="${d>=0?'pos':'neg'}">${d>0?'+':''}${d} <br> ${p}</span>`;
    }

    function genAnalysis() {
        let p = parseInt(document.getElementById('plans').value)||0;
        let legB = (parseFloat(document.getElementById('legBToday').value)||0) - (parseFloat(document.getElementById('legBYest').value)||0);
        
        let html = `<b>üìä ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£:</b><br>`;
        if(legB > 0) html += `‚úÖ Leg B ‡§Æ‡§ß‡•ç‡§Ø‡•á ${legB} PV ‡§ö‡•Ä ‡§µ‡§æ‡§¢ ‡§ù‡§æ‡§≤‡•Ä ‡§Ü‡§π‡•á. ‡§õ‡§æ‡§®!<br>`;
        else if(legB < 0) html += `üî¥ Leg B ‡§ï‡§Æ‡•Ä ‡§ù‡§æ‡§≤‡§æ ‡§Ü‡§π‡•á. ‡§°‡•á‡§™‡•ç‡§• ‡§ö‡•á‡§ï ‡§ï‡§∞‡§æ.<br>`;
        else html += `‚ö†Ô∏è Leg B ‡§∏‡•ç‡§•‡§ø‡§∞ ‡§Ü‡§π‡•á. ‡§π‡§æ‡§≤‡§ö‡§æ‡§≤ ‡§µ‡§æ‡§¢‡§µ‡§æ.<br>`;

        if(p==0) html += `üî¥ ‡§Ü‡§ú ‡§™‡•ç‡§≤‡§æ‡§® ‡§∂‡•ã (Plan) ‡§ù‡§æ‡§≤‡§æ ‡§®‡§æ‡§π‡•Ä. ‡§¨‡§ø‡§ù‡§®‡•á‡§∏‡§∏‡§æ‡§†‡•Ä ‡§ò‡§æ‡§§‡§ï ‡§Ü‡§π‡•á.<br>`;
        else html += `‚úÖ ${p} ‡§™‡•ç‡§≤‡§æ‡§® ‡§¶‡§æ‡§ñ‡§µ‡§≤‡•á. ‡§∏‡§æ‡§§‡§§‡•ç‡§Ø ‡§†‡•á‡§µ‡§æ.<br>`;

        document.getElementById('analysisText').innerHTML = html;
        document.getElementById('analysisBox').style.display = 'block';
        return html;
    }

    function shareWA() {
        let date = document.getElementById('reportDate').value;
        let txt = document.getElementById('analysisText').innerText;
        window.open(`https://wa.me/?text=üáÆüá≥ *RCM Report (${date})*%0a----------------%0a${txt}`, '_blank');
    }

    function dlPDF() {
        genAnalysis(); // Ensure analysis is updated
        const el = document.getElementById('reportContent');
        const opt = { margin:0.2, filename:`RCM_${document.getElementById('reportDate').value}.pdf`, image:{type:'jpeg',quality:0.98}, html2canvas:{scale:2}, jsPDF:{unit:'in', format:'a4', orientation:'portrait'} };
        
        // Timeout to ensure rendering
        setTimeout(() => { html2pdf().set(opt).from(el).save(); }, 500);
    }
</script>

</body>
</html>
