<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RCM Professional Tracker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --primary: #1a237e; /* Professional Blue */
            --accent: #d32f2f;  /* RCM Red */
            --bg: #f4f6f8;      /* Clean Gray */
            --text: #333;
            --white: #ffffff;
        }

        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); margin: 0; padding: 15px; color: var(--text); }
        .container { max-width: 750px; margin: 0 auto; background: var(--white); padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }

        /* --- Header (Clean & Classy) --- */
        .header { text-align: center; border-bottom: 3px solid var(--primary); padding-bottom: 20px; margin-bottom: 20px; }
        .header h1 { color: var(--primary); margin: 0; font-size: 1.8rem; text-transform: uppercase; letter-spacing: 1px; }
        .header p { color: #666; margin: 5px 0 0 0; font-weight: bold; }
        .flag-strip { height: 6px; background: linear-gradient(90deg, #FF9933, #FFFFFF, #138808); margin-top: 10px; border-radius: 3px; }

        /* --- Date & Load --- */
        .controls { background: #e8eaf6; padding: 10px; border-radius: 8px; text-align: center; margin-bottom: 20px; display: flex; justify-content: center; gap: 10px; align-items: center; }
        .date-inp { padding: 8px; border: 1px solid #ccc; border-radius: 5px; font-weight: bold; }
        .btn-load { background: var(--primary); color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; }

        /* --- Business Stats (Table Look) --- */
        .stats-box { border: 1px solid #ddd; border-radius: 8px; overflow: hidden; margin-bottom: 25px; }
        .stats-header { background: #37474f; color: white; padding: 10px; font-weight: bold; text-align: center; }
        .stats-grid { display: grid; grid-template-columns: 1.5fr 1fr 1fr 1fr; padding: 10px; gap: 10px; background: #fff; align-items: center; border-bottom: 1px solid #eee; }
        .stats-grid:last-child { border-bottom: none; }
        .stats-label { font-weight: 600; font-size: 0.9rem; }
        .stats-inp { width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px; text-align: center; font-weight: bold; }
        .stats-ro { background: #f5f5f5; color: #555; border: 1px dashed #ccc; }
        .growth { font-size: 0.85rem; font-weight: bold; text-align: center; }
        .pos { color: green; } .neg { color: red; }

        /* --- GASES Sections (Clean Cards) --- */
        .section { margin-bottom: 20px; border: 1px solid #e0e0e0; border-radius: 8px; background: #fff; overflow: hidden; }
        .sec-head { background: #f5f5f5; padding: 10px 15px; font-weight: bold; color: var(--primary); border-bottom: 1px solid #eee; display: flex; align-items: center; }
        .sec-icon { background: var(--primary); color: white; width: 24px; height: 24px; display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; margin-right: 10px; font-size: 0.8rem; }
        .sec-body { padding: 15px; }

        .row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .row label { font-size: 0.95rem; cursor: pointer; flex: 1; }
        .inp-check { width: 18px; height: 18px; cursor: pointer; accent-color: var(--primary); }
        .inp-num { width: 70px; padding: 5px; border: 1px solid #ccc; border-radius: 4px; text-align: center; font-weight: bold; }

        /* --- New: Self Improvement --- */
        .text-area { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; margin-top: 5px; font-family: inherit; resize: vertical; min-height: 60px; }

        /* --- Buttons --- */
        .action-area { margin-top: 30px; display: flex; flex-direction: column; gap: 10px; }
        .btn-main { padding: 12px; border: none; border-radius: 6px; font-size: 1rem; font-weight: bold; color: white; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: 0.2s; }
        .btn-save { background: #2e7d32; }
        .btn-calc { background: #1565c0; }
        .btn-pdf { background: #c62828; }
        
        #resultArea { margin-top: 20px; padding: 20px; background: #e3f2fd; border-radius: 8px; border-left: 5px solid var(--primary); display: none; }
        .report-text { font-size: 0.95rem; line-height: 1.6; }
        
        #msg { text-align: center; font-weight: bold; margin: 10px 0; min-height: 20px; }
    </style>
</head>
<body>

<div class="container" id="reportContent">
    
    <div class="header">
        <h1>üáÆüá≥ GASES ‡§ó‡•Å‡§∞‡•Å‡§Æ‡§Ç‡§§‡•ç‡§∞ ‡§ü‡•ç‡§∞‡•Ö‡§ï‡§∞</h1>
        <p>Professional Business Analysis System</p>
        <div class="flag-strip"></div>
    </div>

    <div class="controls" data-html2canvas-ignore="true">
        <label>Date:</label>
        <input type="date" id="reportDate" class="date-inp">
        <button class="btn-load" onclick="window.loadFromFirebase()">Load Data</button>
    </div>
    <div id="msg"></div>

    <div class="stats-box">
        <div class="stats-header">üìä BUSINESS GROWTH (PV)</div>
        <div class="stats-grid" style="background:#eee;">
            <div>Type</div> <div>Today</div> <div>Yesterday</div> <div>Growth</div>
        </div>
        <div class="stats-grid">
            <div class="stats-label">Total PV</div>
            <input type="number" id="totalToday" class="stats-inp" placeholder="0" oninput="calcGrowth()">
            <input type="number" id="totalYest" class="stats-inp stats-ro" placeholder="0" readonly>
            <div id="gTotal" class="growth">-</div>
        </div>
        <div class="stats-grid">
            <div class="stats-label" style="color:green;">Leg A</div>
            <input type="number" id="legAToday" class="stats-inp" placeholder="0" oninput="calcGrowth()">
            <input type="number" id="legAYest" class="stats-inp stats-ro" placeholder="0" readonly>
            <div id="gLegA" class="growth">-</div>
        </div>
        <div class="stats-grid">
            <div class="stats-label" style="color:red;">Leg B</div>
            <input type="number" id="legBToday" class="stats-inp" placeholder="0" oninput="calcGrowth()">
            <input type="number" id="legBYest" class="stats-inp stats-ro" placeholder="0" readonly>
            <div id="gLegB" class="growth">-</div>
        </div>
    </div>

    <form id="trackerForm">
        
        <div class="section">
            <div class="sec-head"><div class="sec-icon">G</div> ‡§ó‡•ç‡§∞‡•ã‡§• (Growth)</div>
            <div class="sec-body">
                <div class="row">
                    <label>‡§Æ‡§π‡§ø‡§®‡•ç‡§Ø‡§æ‡§ö‡•á ‡§ü‡§æ‡§∞‡•ç‡§ó‡•á‡§ü (Target)</label>
                    <select id="target" style="padding:5px;"><option>Normal</option><option>25%</option><option>50%</option><option>100%</option></select>
                </div>
                <div class="row"><label>‡§™‡•ç‡§≤‡§æ‡§® ‡§∂‡•ã (Plan Count)</label> <input type="number" id="plans" class="inp-num" placeholder="0"></div>
                <div class="row"><label>‡§®‡§µ‡•Ä‡§® Vital / ‡§∏‡•ç‡§ü‡•á‡§∂‡§® ‡§ì‡§™‡§®‡§ø‡§Ç‡§ó</label> <input type="checkbox" id="g_vital" class="inp-check"></div>
            </div>
        </div>

        <div class="section">
            <div class="sec-head"><div class="sec-icon">A</div> ‡§è‡§ï‡•ç‡§ü‡§ø‡§µ (Active)</div>
            <div class="sec-body">
                <div class="row"><label>‡§ï‡•â‡§≤‡§ø‡§Ç‡§ó (Calls)</label> <input type="number" id="calls" class="inp-num" placeholder="0"></div>
                <div class="row"><label>‡§Æ‡•Ä‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏ (Meetings)</label> <input type="number" id="meetings" class="inp-num" placeholder="0"></div>
                <div class="row"><label>Zero ID / ULP ‡§ö‡•á‡§ï</label> <input type="checkbox" id="a_zero" class="inp-check"></div>
            </div>
        </div>

        <div class="section">
            <div class="sec-head"><div class="sec-icon">S</div> ‡§ñ‡§∞‡•á‡§¶‡•Ä (Self Purchase)</div>
            <div class="sec-body">
                <div class="row"><label>‡§∏‡•á‡§≤‡•ç‡§´ PV (‚Çπ)</label> <input type="number" id="pv" class="inp-num" placeholder="‚Çπ"></div>
                <div class="row"><label>‡§°‡§æ‡§Ø‡§Æ‡§Ç‡§° ‡§ï‡•ç‡§≤‡§¨ / ‡§¨‡§ø‡§≤‡§ø‡§Ç‡§ó</label> <input type="checkbox" id="s_diamond" class="inp-check"></div>
            </div>
        </div>

        <div class="section" style="border-left: 4px solid #ff9800;">
            <div class="sec-head"><div class="sec-icon" style="background:#ff9800;">üß†</div> ‡§∏‡•á‡§≤‡•ç‡§´ ‡§á‡§Æ‡•ç‡§™‡•ç‡§∞‡•Ç‡§µ‡•ç‡§π‡§Æ‡•á‡§Ç‡§ü (Self Improvement)</div>
            <div class="sec-body">
                <label style="font-weight:bold;">‡§Ü‡§ú ‡§ï‡§æ‡§Ø ‡§®‡§µ‡•Ä‡§® ‡§∂‡§ø‡§ï‡§≤‡§æ‡§§ / ‡§µ‡§æ‡§ö‡§≤‡•á?</label>
                <textarea id="selfImp" class="text-area" placeholder="‡§Ø‡•á‡§•‡•á ‡§≤‡§ø‡§π‡§æ... (‡§â‡§¶‡§æ. ‡§™‡•Å‡§∏‡•ç‡§§‡§ï‡§æ‡§ö‡•Ä 2 ‡§™‡§æ‡§®‡•á ‡§µ‡§æ‡§ö‡§≤‡•Ä, ‡§®‡§µ‡•Ä‡§® ‡§µ‡•ç‡§π‡§ø‡§°‡§ø‡§ì ‡§™‡§æ‡§π‡§ø‡§≤‡§æ)"></textarea>
            </div>
        </div>

        <div class="section">
            <div class="sec-head"><div class="sec-icon">S</div> ‡§∏‡•ã‡§∂‡§≤ (Social)</div>
            <div class="sec-body">
                <div class="row"><label>‡§∏‡§Ç‡§¨‡§Ç‡§ß / ‡§Æ‡§æ‡§´‡•Ä (Forgiveness)</label> <input type="checkbox" id="so_relation" class="inp-check"></div>
            </div>
        </div>

        <div id="resultArea">
            <h3 style="margin-top:0; color:var(--primary);">üìà ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü (Analysis)</h3>
            <div id="reportText" class="report-text"></div>
        </div>

    </form>
</div>

<div class="container" style="background:transparent; box-shadow:none; margin-top:0; padding-top:0;">
    <div class="action-area">
        <button class="btn-main btn-save" onclick="window.saveToFirebase()">üíæ ‡§°‡•á‡§ü‡§æ ‡§∏‡•á‡§µ‡•ç‡§π ‡§ï‡§∞‡§æ (Save)</button>
        <button class="btn-main btn-calc" onclick="generateReport()">üìä ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§¨‡§®‡§µ‡§æ (Analyze)</button>
        <button class="btn-main btn-pdf" onclick="downloadPDF()">üì• PDF ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡§æ</button>
    </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = { apiKey: "AIzaSyCsgwBoTiEtSNJ2xMm4di0F0GiAtFxoswM", authDomain: "order-b15a8.firebaseapp.com", projectId: "order-b15a8", storageBucket: "order-b15a8.firebasestorage.app", messagingSenderId: "614443594278", appId: "1:614443594278:web:e31715b6ee592b30326ce7" };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const dateInput = document.getElementById('reportDate');
  const msg = document.getElementById('msg');
  
  dateInput.valueAsDate = new Date();

  // Load
  window.onload = function() { window.loadFromFirebase(); };

  // SAVE
  window.saveToFirebase = async function() {
    const dateVal = dateInput.value;
    if(!dateVal) { alert("‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§®‡§ø‡§µ‡§°‡§æ!"); return; }
    msg.innerText = "Saving..."; msg.style.color = "blue";

    const data = {
        // Business
        totalToday: val('totalToday'), legAToday: val('legAToday'), legBToday: val('legBToday'),
        // GASES
        target: val('target', false), plans: val('plans'), g_vital: chk('g_vital'),
        calls: val('calls'), meetings: val('meetings'), a_zero: chk('a_zero'),
        pv: val('pv'), s_diamond: chk('s_diamond'),
        selfImp: val('selfImp', false), // New Field
        so_relation: chk('so_relation'),
        timestamp: new Date()
    };

    try {
        await setDoc(doc(db, "rcm_permanent_data", dateVal), data);
        msg.innerText = "‚úÖ ‡§°‡•á‡§ü‡§æ ‡§∏‡•á‡§µ‡•ç‡§π ‡§ù‡§æ‡§≤‡§æ!"; msg.style.color = "green";
        generateReport(); // Show report immediately
    } catch (e) {
        msg.innerText = "‚ùå Error: " + e.message; msg.style.color = "red";
    }
  }

  // LOAD
  window.loadFromFirebase = async function() {
    const dateVal = dateInput.value;
    if(!dateVal) return;
    msg.innerText = "Loading..."; msg.style.color = "blue";
    
    // Get Yesterday
    const prevDate = new Date(dateVal);
    prevDate.setDate(prevDate.getDate() - 1);
    const yestVal = prevDate.toISOString().split('T')[0];

    try {
        // Load Today
        const snap = await getDoc(doc(db, "rcm_permanent_data", dateVal));
        if(snap.exists()) {
            const d = snap.data();
            setVal('totalToday', d.totalToday); setVal('legAToday', d.legAToday); setVal('legBToday', d.legBToday);
            document.getElementById('target').value = d.target || "Normal";
            setVal('plans', d.plans); setChk('g_vital', d.g_vital);
            setVal('calls', d.calls); setVal('meetings', d.meetings); setChk('a_zero', d.a_zero);
            setVal('pv', d.pv); setChk('s_diamond', d.s_diamond);
            setVal('selfImp', d.selfImp); // Load Text Area
            setChk('so_relation', d.so_relation);
            msg.innerText = "‚úÖ ‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§ù‡§æ‡§≤‡§æ."; msg.style.color = "green";
        } else {
            document.getElementById('trackerForm').reset();
            msg.innerText = "‚ö†Ô∏è ‡§Ü‡§ú‡§ö‡§æ ‡§°‡•á‡§ü‡§æ ‡§®‡§æ‡§π‡•Ä."; msg.style.color = "orange";
        }

        // Load Yesterday
        const ySnap = await getDoc(doc(db, "rcm_permanent_data", yestVal));
        if(ySnap.exists()) {
            setVal('totalYest', ySnap.data().totalToday);
            setVal('legAYest', ySnap.data().legAToday);
            setVal('legBYest', ySnap.data().legBToday);
        } else {
            setVal('totalYest', 0); setVal('legAYest', 0); setVal('legBYest', 0);
        }
        window.calcGrowth();

    } catch (e) { console.error(e); }
  }

  function val(id, isN=true) { return isN ? (document.getElementById(id).value || "") : document.getElementById(id).value; }
  function chk(id) { return document.getElementById(id).checked; }
  function setVal(id, v) { document.getElementById(id).value = v || ""; }
  function setChk(id, v) { document.getElementById(id).checked = v || false; }

  document.getElementById('reportDate').addEventListener('change', window.loadFromFirebase);
</script>

<script>
    // Growth Logic
    window.calcGrowth = function() {
        doCalc('totalToday', 'totalYest', 'gTotal');
        doCalc('legAToday', 'legAYest', 'gLegA');
        doCalc('legBToday', 'legBYest', 'gLegB');
    }
    function doCalc(t, y, r) {
        let T = parseFloat(document.getElementById(t).value)||0;
        let Y = parseFloat(document.getElementById(y).value)||0;
        let d = T-Y;
        let p = Y>0 ? ((d/Y)*100).toFixed(1)+"%" : "";
        let el = document.getElementById(r);
        el.innerHTML = `<span class="${d>=0?'pos':'neg'}">${d>0?'+':''}${d} <br> ${p}</span>`;
    }

    // Report Generation
    function generateReport() {
        let plans = parseInt(document.getElementById('plans').value)||0;
        let legB = parseFloat(document.getElementById('legBToday').value)||0;
        let legBY = parseFloat(document.getElementById('legBYest').value)||0;
        let selfImp = document.getElementById('selfImp').value;

        let html = ``;
        
        // Marathi Analysis
        html += `<strong>1. ‡§¨‡§ø‡§ù‡§®‡•á‡§∏ ‡§∏‡•ç‡§•‡§ø‡§§‡•Ä:</strong><br>`;
        if(legB > legBY) html += `üü¢ ‡§Ö‡§≠‡§ø‡§®‡§Ç‡§¶‡§®! Leg B ‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§™‡•ç‡§∞‡§ó‡§§‡•Ä ‡§Ü‡§π‡•á.`;
        else if(legB < legBY) html += `üî¥ ‡§∏‡§æ‡§µ‡§ß‡§æ‡§®! Leg B ‡§ï‡§Æ‡•Ä ‡§ù‡§æ‡§≤‡§æ ‡§Ü‡§π‡•á.`;
        else html += `üü° Leg B ‡§∏‡•ç‡§•‡§ø‡§∞ ‡§Ü‡§π‡•á.`;
        
        html += `<br><br><strong>2. ‡§ç‡§ï‡•ç‡§∂‡§® ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü:</strong><br>`;
        if(plans === 0) html += `‚ö†Ô∏è ‡§Ü‡§ú ‡§™‡•ç‡§≤‡§æ‡§® ‡§∂‡•ã ‡§ù‡§æ‡§≤‡§æ ‡§®‡§æ‡§π‡•Ä. ‡§π‡•á ‡§µ‡§æ‡§¢‡•Ä‡§∏‡§æ‡§†‡•Ä ‡§ò‡§æ‡§§‡§ï ‡§Ü‡§π‡•á.<br>`;
        else html += `‚úÖ ${plans} ‡§™‡•ç‡§≤‡§æ‡§® ‡§∂‡•ã ‡§ù‡§æ‡§≤‡•á. ‡§â‡§§‡•ç‡§§‡§Æ!<br>`;

        if(selfImp) html += `<br><strong>3. ‡§Ü‡§ú‡§ö‡•Ä ‡§∂‡§ø‡§ï‡§µ‡§£:</strong><br><i>"${selfImp}"</i>`;
        else html += `<br><strong>3. ‡§Ü‡§ú‡§ö‡•Ä ‡§∂‡§ø‡§ï‡§µ‡§£:</strong><br>‚ö†Ô∏è ‡§ï‡§æ‡§π‡•Ä‡§π‡•Ä ‡§®‡•ã‡§Ç‡§¶ ‡§®‡§æ‡§π‡•Ä.`;

        document.getElementById('reportText').innerHTML = html;
        document.getElementById('resultArea').style.display = 'block';
    }

    // Fix PDF
    function downloadPDF() {
        generateReport();
        const element = document.getElementById('reportContent');
        const opt = {
            margin: 0.2,
            filename: `RCM_Report_${document.getElementById('reportDate').value}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, useCORS: true },
            jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
        };
        // Wait specifically for DOM update
        setTimeout(() => {
            html2pdf().set(opt).from(element).save();
        }, 500);
    }
</script>

</body>
</html>
