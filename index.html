<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RCM Dynamic Tracker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --primary-color: #000080;
            --saffron: #FF9933;
            --white: #FFFFFF;
            --green: #138808;
            --secondary-color: #e3f2fd;
            --text-color: #333;
            --border-radius: 12px;
        }

        body { font-family: 'Segoe UI', sans-serif; background-color: #f4f6f8; margin: 0; padding: 10px; color: var(--text-color); }
        .container { max-width: 700px; margin: 0 auto; background: white; padding: 20px; border-radius: var(--border-radius); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }

        /* --- HEADER --- */
        .flag-header-container {
            position: relative; background: linear-gradient(180deg, var(--saffron) 33.33%, var(--white) 33.33%, var(--white) 66.66%, var(--green) 66.66%);
            padding: 40px 10px; text-align: center; border-radius: 12px; margin-bottom: 10px; overflow: hidden; box-shadow: 0 6px 15px rgba(0,0,0,0.3); border: 1px solid #ddd;
        }
        .flag-wave {
            position: absolute; top: 0; left: -150%; width: 300%; height: 100%;
            background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(0,0,0,0.15) 20%, rgba(255,255,255,0.2) 35%, rgba(0,0,0,0.15) 50%, rgba(255,255,255,0.2) 65%, rgba(0,0,0,0.15) 80%, rgba(255,255,255,0) 100%);
            animation: flutter 4s linear infinite; pointer-events: none; z-index: 1;
        }
        @keyframes flutter { 0% { transform: translateX(0); } 100% { transform: translateX(50%); } }
        .header-title { position: relative; z-index: 2; color: var(--primary-color); font-size: 1.8rem; font-weight: 900; text-transform: uppercase; text-shadow: 3px 3px 0px #ffffff, -1px -1px 0px #ffffff; margin: 0; }
        .header-subtitle { position: relative; z-index: 2; background: rgba(255, 255, 255, 0.9); padding: 5px 15px; border-radius: 20px; margin-top: 10px; font-size: 1rem; font-weight: bold; display: inline-block; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        /* --- COUNTDOWN --- */
        .countdown-box {
            background: #d32f2f; color: white; text-align: center; padding: 10px; border-radius: 8px; margin-bottom: 20px; font-weight: bold; font-size: 1.1rem;
            animation: pulse 2s infinite; box-shadow: 0 4px 8px rgba(211, 47, 47, 0.3);
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

        /* --- CSS (Standard) --- */
        .business-section { background-color: #fffde7; border: 2px solid #fbc02d; border-radius: 10px; padding: 15px; margin-bottom: 20px; }
        .business-title { color: #e65100; font-weight: bold; text-align: center; margin-bottom: 10px; border-bottom: 1px dashed #f57f17; padding-bottom: 5px; font-size: 1.1rem; }
        .biz-grid-row { display: grid; grid-template-columns: 1.3fr 1fr 1fr 1.2fr; gap: 5px; align-items: center; margin-bottom: 8px; }
        .biz-head { font-size: 0.8rem; font-weight: bold; text-align: center; color: #555; }
        .biz-label { font-weight: bold; font-size: 0.9rem; color: var(--primary-color); }
        .biz-input { width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 5px; text-align: center; font-weight: bold; font-size: 1rem; }
        .biz-readonly { background: #eee; color: #777; border: 1px dashed #aaa; } 
        .growth-display { font-size: 0.8rem; font-weight: bold; text-align: center; }
        .pos { color: green; } .neg { color: red; }

        .gases-section { margin-bottom: 15px; border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden; background: #fff; }
        .section-header { background-color: var(--secondary-color); padding: 10px 15px; display: flex; align-items: center; font-weight: bold; color: var(--primary-color); font-size: 1.1rem; }
        .sub-task-list { padding: 10px 15px; }
        .task-item { display: flex; align-items: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px dashed #eee; justify-content: space-between; }
        .task-item input[type="checkbox"] { width: 20px; height: 20px; margin-right: 12px; cursor: pointer; }
        .num-input { width: 70px; padding: 5px; border: 2px solid var(--primary-color); border-radius: 5px; text-align: center; font-weight: bold; margin-left: 10px; }
        .task-label { font-size: 0.95rem; cursor: pointer; color: #333; }
        .task-category { font-size: 0.75rem; color: #ff6f00; font-weight: bold; display: block; margin-bottom: 2px; }
        .select-target { padding: 5px; border-radius: 5px; border: 1px solid #ccc; font-weight: bold; }

        /* --- NEW: DYNAMIC PLAN INPUTS --- */
        .plan-row { display: flex; margin-bottom: 10px; gap: 5px; }
        .plan-input { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-family: inherit; }
        .btn-add-plan { background: #e65100; color: white; border: none; padding: 8px 15px; border-radius: 20px; font-size: 0.9rem; cursor: pointer; font-weight: bold; }
        .btn-remove-plan { background: #ffcdd2; color: #c62828; border: none; width: 30px; border-radius: 5px; cursor: pointer; font-weight: bold; }

        .date-container { text-align: center; margin-bottom: 15px; }
        .btn-submit { background: var(--primary-color); color: white; border: none; padding: 15px; width: 100%; border-radius: 50px; font-weight: bold; cursor: pointer; margin-top: 10px; transition: 0.3s; font-size: 1.1rem; }
        .btn-save { background: var(--green); margin-top: 20px; }
        .btn-pdf { background: #d32f2f; }
        .btn-whatsapp { background: #25D366; }
        
        #loadingMsg { text-align: center; color: var(--primary-color); font-weight: bold; display: none; margin-bottom: 10px; }
        #resultArea { display: none; margin-top: 15px; padding: 15px; background: #fff3e0; border-left: 5px solid #ff9800; border-radius: 5px; }
        .letter-icon { background: var(--primary-color); color: white; width: 30px; height: 30px; display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; margin-right: 10px; }
    </style>
</head>
<body>

<div class="container" id="reportContent">
    
    <div class="flag-header-container">
        <div class="flag-wave"></div>
        <h1 class="header-title">üáÆüá≥ ‡§®‡§è ‡§≠‡§æ‡§∞‡§§ ‡§ï‡§æ ‡§®‡§ø‡§∞‡•ç‡§Æ‡§æ‡§£ üáÆüá≥</h1>
        <div class="header-subtitle">RCM ‡§∏‡§Ç‡§™‡•Ç‡§∞‡•ç‡§£ ‡§¨‡§ø‡§ù‡§®‡•á‡§∏ ‡§ü‡•ç‡§∞‡•Ö‡§ï‡§∞</div>
    </div>

    <div class="countdown-box" id="countdownTimer">
        üî• Mission March 2026: ‡§´‡§ï‡•ç‡§§ ... ‡§¶‡§ø‡§µ‡§∏ ‡§¨‡§æ‡§ï‡•Ä! üî•
    </div>

    <div class="date-container" data-html2canvas-ignore="true">
        <label><b>‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§®‡§ø‡§µ‡§°‡§æ:</b> </label>
        <input type="date" id="reportDate" style="padding: 5px; border-radius: 5px;">
        <button id="btnLoad" style="padding: 5px; cursor: pointer;">üîÑ ‡§ú‡•Å‡§®‡§æ ‡§°‡•á‡§ü‡§æ ‡§™‡§π‡§æ</button>
    </div>
    <div id="loadingMsg">üîÑ ‡§ï‡•ç‡§≤‡§æ‡§â‡§° ‡§µ‡§∞‡•Ç‡§® ‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä ‡§ò‡•á‡§§ ‡§Ü‡§π‡•á...</div>

    <form id="trackerForm">

        <div class="business-section">
            <div class="business-title">üìä ‡§¨‡§ø‡§ù‡§®‡•á‡§∏ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§Ü‡§£‡§ø ‡§µ‡§æ‡§¢ (PV)</div>
            <div class="biz-grid-row">
                <div class="biz-head" style="text-align:left;">‡§ó‡•ç‡§∞‡•Å‡§™ / ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞</div>
                <div class="biz-head">‡§Ü‡§ú (Today)</div>
                <div class="biz-head">‡§ï‡§æ‡§≤ (Yesterday)</div>
                <div class="biz-head">‡§µ‡§æ‡§¢ (Growth)</div>
            </div>
            <div class="biz-grid-row">
                <div class="biz-label">‡§è‡§ï‡•Ç‡§£ PV</div>
                <input type="number" id="totalToday" class="biz-input" placeholder="0" oninput="calcGrowth()">
                <input type="number" id="totalYest" class="biz-input biz-readonly" placeholder="0" readonly>
                <div id="gTotal" class="growth-display">-</div>
            </div>
            <div class="biz-grid-row">
                <div class="biz-label" style="color:green">‡§≤‡•á‡§ó A (‡§Æ‡•ã‡§†‡§æ ‡§ó‡•ç‡§∞‡•Å‡§™)</div>
                <input type="number" id="legAToday" class="biz-input" placeholder="0" oninput="calcGrowth()">
                <input type="number" id="legAYest" class="biz-input biz-readonly" placeholder="0" readonly>
                <div id="gLegA" class="growth-display">-</div>
            </div>
            <div class="biz-grid-row">
                <div class="biz-label" style="color:#d84315">‡§≤‡•á‡§ó B (‡§¶‡•Å‡§∏‡§∞‡§æ ‡§ó‡•ç‡§∞‡•Å‡§™)</div>
                <input type="number" id="legBToday" class="biz-input" placeholder="0" oninput="calcGrowth()">
                <input type="number" id="legBYest" class="biz-input biz-readonly" placeholder="0" readonly>
                <div id="gLegB" class="growth-display">-</div>
            </div>
        </div>
        
        <div class="gases-section">
            <div class="section-header"><div><span class="letter-icon">G</span> ‡§ó‡•ç‡§∞‡•ã‡§• (Growth)</div></div>
            <div class="sub-task-list">
                <div class="task-item"><div class="task-left"><label class="task-label"><span class="task-category">TARGET</span>‡§Æ‡§π‡§ø‡§®‡•ç‡§Ø‡§æ‡§ö‡•á ‡§ó‡•ç‡§∞‡•ã‡§• ‡§ü‡§æ‡§∞‡•ç‡§ó‡•á‡§ü</label></div><select id="growthTarget" class="select-target"><option value="0">‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø</option><option value="25">25% ‡§µ‡§æ‡§¢</option><option value="50">50% ‡§µ‡§æ‡§¢</option><option value="100">100% (‡§°‡§¨‡§≤)</option></select></div>
                <div class="task-item"><div class="task-left"><label class="task-label">‡§™‡•ç‡§≤‡§æ‡§® ‡§¶‡§æ‡§ñ‡§µ‡§≤‡•á (Plan Show)</label></div><input type="number" id="numPlan" class="num-input" placeholder="0"></div>
                <div class="task-item"><div class="task-left"><input type="checkbox" id="g_vital" class="track-check"><label for="g_vital" class="task-label">‡§®‡§µ‡•Ä‡§® Vital (Openner/Eagle) ‡§∏‡§æ‡§†‡•Ä ‡§ï‡§æ‡§Æ</label></div></div>
                <div class="task-item"><div class="task-left"><input type="checkbox" id="g_display" class="track-check"><label for="g_display" class="task-label">‡§®‡§µ‡•Ä‡§® ‡§ï‡•á‡§Ç‡§¶‡•ç‡§∞ / ‡§°‡§ø‡§∏‡•ç‡§™‡•ç‡§≤‡•á ‡§µ‡•â‡§≤ ‡§â‡§ò‡§°‡§≤‡•Ä</label></div></div>
            </div>
        </div>

        <div class="gases-section">
            <div class="section-header"><div><span class="letter-icon">A</span> ‡§è‡§ï‡•ç‡§ü‡§ø‡§µ (Active Rate)</div></div>
            <div class="sub-task-list">
                <div class="task-item"><div class="task-left"><label class="task-label">‡§ï‡•â‡§≤‡§ø‡§Ç‡§ó (Follow-up Calls)</label></div><input type="number" id="numCalls" class="num-input" placeholder="0"></div>
                <div class="task-item"><div class="task-left"><label class="task-label">‡§Æ‡•Ä‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏ (Home/Welcome)</label></div><input type="number" id="numMeetings" class="num-input" placeholder="0"></div>
                <div class="task-item"><div class="task-left"><input type="checkbox" id="a_ulp" class="track-check"><label for="a_ulp" class="task-label">ULP (Unique Login) ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§ö‡•á‡§ï ‡§ï‡•á‡§≤‡•Ä</label></div></div>
                <div class="task-item"><div class="task-left"><input type="checkbox" id="a_zero" class="track-check"><label for="a_zero" class="task-label">Zero ID (‡§ñ‡§∞‡•á‡§¶‡•Ä ‡§®‡§∏‡§≤‡•á‡§≤‡•á) ‡§è‡§ï‡•ç‡§ü‡§ø‡§µ ‡§ï‡•á‡§≤‡•á?</label></div></div>
            </div>
        </div>

        <div class="gases-section">
            <div class="section-header"><div><span class="letter-icon">S</span> ‡§∏‡•ç‡§µ‡§§‡§É‡§ö‡•Ä ‡§ñ‡§∞‡•á‡§¶‡•Ä (Self Use)</div></div>
            <div class="sub-task-list">
                <div class="task-item"><div class="task-left"><label class="task-label">‡§µ‡§ø‡§ï‡•ç‡§∞‡•Ä / ‡§∏‡•á‡§≤‡•ç‡§´ PV (‚Çπ)</label></div><input type="number" id="numPV" class="num-input" placeholder="‚Çπ"></div>
                <div class="task-item"><div class="task-left"><input type="checkbox" id="s_diamond" class="track-check"><label for="s_diamond" class="task-label">‡§°‡§æ‡§Ø‡§Æ‡§Ç‡§° ‡§ï‡•ç‡§≤‡§¨ / ‡§∏‡§æ‡§§‡§§‡•ç‡§Ø‡§™‡•Ç‡§∞‡•ç‡§£ ‡§ñ‡§∞‡•á‡§¶‡•Ä</label></div></div>
                <div class="task-item"><div class="task-left"><input type="checkbox" id="s_online" class="track-check"><label for="s_online" class="task-label">‡§∏‡•ç‡§µ‡§§‡§É‡§ö‡•Ä ‡§ë‡§∞‡•ç‡§°‡§∞ ‡§ë‡§®‡§≤‡§æ‡§à‡§® ‡§ü‡§æ‡§ï‡§≤‡•Ä</label></div></div>
                <div class="task-item"><div class="task-left"><input type="checkbox" id="s_billing" class="track-check"><label for="s_billing" class="task-label">‡§≤‡§ó‡•á‡§ö ‡§¨‡§ø‡§≤‡§ø‡§Ç‡§ó (Immediate Billing) ‡§ï‡•á‡§≤‡•á</label></div></div>
            </div>
        </div>

        <div class="gases-section">
            <div class="section-header"><div><span class="letter-icon">E</span> ‡§∂‡§ø‡§ï‡•ç‡§∑‡§£ (Education)</div></div>
            <div class="sub-task-list">
                <div class="task-item"><div class="task-left"><input type="checkbox" id="e_learn" class="track-check"><label for="e_learn" class="task-label">‡§ó‡•Å‡§∞‡•Å‡§ï‡•Å‡§≤ / ‡§â‡§°‡§æ‡§® ‡§µ‡•ç‡§π‡§ø‡§°‡§ø‡§ì ‡§™‡§æ‡§π‡§ø‡§≤‡§æ</label></div></div>
                <div class="task-item"><div class="task-left"><input type="checkbox" id="e_book" class="track-check"><label for="e_book" class="task-label">‡§™‡•Å‡§∏‡•ç‡§§‡§ï ‡§µ‡§æ‡§ö‡§® (30 ‡§Æ‡§ø‡§®‡§ø‡§ü‡•á)</label></div></div>
                <div class="task-item"><div class="task-left"><input type="checkbox" id="e_teach" class="track-check"><label for="e_teach" class="task-label">‡§ü‡•Ä‡§Æ ‡§ü‡•ç‡§∞‡•á‡§®‡§ø‡§Ç‡§ó (Duplication)</label></div></div>
            </div>
        </div>

        <div class="gases-section">
            <div class="section-header"><div><span class="letter-icon">S</span> ‡§∏‡§æ‡§Æ‡§æ‡§ú‡§ø‡§ï (Social)</div></div>
            <div class="sub-task-list">
                <div class="task-item"><div class="task-left"><input type="checkbox" id="so_relation" class="track-check"><label for="so_relation" class="task-label">‡§®‡§æ‡§§‡•á‡§µ‡§æ‡§à‡§ï/‡§Æ‡§ø‡§§‡•ç‡§∞ ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï (Relationship)</label></div></div>
                <div class="task-item"><div class="task-left"><input type="checkbox" id="so_forgive" class="track-check"><label for="so_forgive" class="task-label">‡§Æ‡§®‡§æ‡§§‡•Ä‡§≤ ‡§∞‡§æ‡§ó ‡§∏‡•ã‡§°‡§≤‡§æ / ‡§Æ‡§æ‡§´‡•Ä (Forgiveness)</label></div></div>
                <div class="task-item"><div class="task-left"><input type="checkbox" id="so_health" class="track-check"><label for="so_health" class="task-label">‡§Ü‡§∞‡•ã‡§ó‡•ç‡§Ø / ‡§∏‡•á‡§µ‡§æ ‡§ï‡§æ‡§∞‡•ç‡§Ø (Seva)</label></div></div>
            </div>
        </div>
        
        <div class="gases-section" style="border-color: #ff9800;">
            <div class="section-header" style="background: #fff3e0; color: #e65100;">
                <div><span class="letter-icon" style="background:#e65100">üìù</span> ‡§â‡§¶‡•ç‡§Ø‡§æ‡§ö‡•á ‡§®‡§ø‡§Ø‡•ã‡§ú‡§® (Tomorrow's Plan)</div>
            </div>
            
            <div class="sub-task-list" id="planContainer">
                </div>
            
            <div style="padding: 10px; text-align: center;">
                <button type="button" class="btn-add-plan" onclick="addPlanField()">+ ‡§Ü‡§£‡§ñ‡•Ä ‡§ï‡§æ‡§Æ ‡•≤‡§° ‡§ï‡§∞‡§æ (Add Task)</button>
            </div>
        </div>

        <div id="resultArea">
            <strong>üìä AI ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£:</strong>
            <p id="analysisText">...</p>
        </div>

    </form>
</div>

<div class="container" style="background: transparent; box-shadow: none; margin-top: 0; padding-top: 0;">
    <button type="button" class="btn-submit btn-save" id="btnSaveData">‚òÅÔ∏è ‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä ‡§ï‡•ç‡§≤‡§æ‡§â‡§°‡§µ‡§∞ ‡§∏‡•á‡§µ‡•ç‡§π ‡§ï‡§∞‡§æ</button>
    <button type="button" class="btn-submit" id="btnCalc">üîç ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§ï‡§∞‡§æ (Analyze)</button>
    <button type="button" class="btn-submit btn-whatsapp" onclick="shareToWhatsApp()">üì≤ WhatsApp ‡§µ‡§∞ ‡§™‡§æ‡§†‡§µ‡§æ</button>
    <button type="button" class="btn-submit btn-pdf" id="btnDownloadPDF">üì• PDF ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡§æ</button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCsgwBoTiEtSNJ2xMm4di0F0GiAtFxoswM",
    authDomain: "order-b15a8.firebaseapp.com",
    projectId: "order-b15a8",
    storageBucket: "order-b15a8.firebasestorage.app",
    messagingSenderId: "614443594278",
    appId: "1:614443594278:web:e31715b6ee592b30326ce7"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const dateInput = document.getElementById('reportDate');
  const loadingMsg = document.getElementById('loadingMsg');
  
  dateInput.valueAsDate = new Date();

  // Load Date & Calculate Countdown
  window.onload = function() {
    window.loadFromFirebase();
    updateCountdown();
  };

  // 1. SAVE FUNCTION (Modified for Dynamic Plans)
  window.saveToFirebase = async function() {
    const dateVal = dateInput.value;
    if(!dateVal) { alert("‡§ï‡•É‡§™‡§Ø‡§æ ‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§®‡§ø‡§µ‡§°‡§æ!"); return; }
    loadingMsg.style.display = 'block';

    // Collect Plans
    const planInputs = document.querySelectorAll('.dynamic-plan');
    let plansList = [];
    planInputs.forEach(input => {
        if(input.value.trim() !== "") plansList.push(input.value.trim());
    });

    const data = {
        totalToday: document.getElementById('totalToday').value,
        legAToday: document.getElementById('legAToday').value,
        legBToday: document.getElementById('legBToday').value,
        target: document.getElementById('growthTarget').value,
        plans: document.getElementById('numPlan').value,
        g_vital: document.getElementById('g_vital').checked,
        g_display: document.getElementById('g_display').checked,
        calls: document.getElementById('numCalls').value,
        meetings: document.getElementById('numMeetings').value,
        a_ulp: document.getElementById('a_ulp').checked,
        a_zero: document.getElementById('a_zero').checked,
        pv: document.getElementById('numPV').value,
        s_diamond: document.getElementById('s_diamond').checked,
        s_online: document.getElementById('s_online').checked,
        s_billing: document.getElementById('s_billing').checked,
        e_learn: document.getElementById('e_learn').checked,
        e_book: document.getElementById('e_book').checked,
        e_teach: document.getElementById('e_teach').checked,
        so_relation: document.getElementById('so_relation').checked,
        so_forgive: document.getElementById('so_forgive').checked,
        so_health: document.getElementById('so_health').checked,
        
        // Save Plans List
        plansList: plansList,
        lastUpdated: new Date()
    };

    try {
        await setDoc(doc(db, "rcm_marathi_tracker", dateVal), data);
        alert("‚úÖ ‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§∏‡•á‡§µ‡•ç‡§π ‡§ù‡§æ‡§≤‡•Ä!");
    } catch (error) {
        alert("Error: " + error.message);
    } finally {
        loadingMsg.style.display = 'none';
    }
  }

  // 2. LOAD FUNCTION
  window.loadFromFirebase = async function() {
    const dateVal = dateInput.value;
    if(!dateVal) return;
    loadingMsg.style.display = 'block';
    
    const current = new Date(dateVal);
    current.setDate(current.getDate() - 1);
    const yestVal = current.toISOString().split('T')[0];

    try {
        const docRef = doc(db, "rcm_marathi_tracker", dateVal);
        const docSnap = await getDoc(docRef);

        // Reset Dynamic Fields
        document.getElementById('planContainer').innerHTML = "";

        if (docSnap.exists()) {
            const data = docSnap.data();
            document.getElementById('totalToday').value = data.totalToday || "";
            document.getElementById('legAToday').value = data.legAToday || "";
            document.getElementById('legBToday').value = data.legBToday || "";
            document.getElementById('growthTarget').value = data.target || 0;
            document.getElementById('numPlan').value = data.plans || "";
            document.getElementById('g_vital').checked = data.g_vital || false;
            document.getElementById('g_display').checked = data.g_display || false;
            document.getElementById('numCalls').value = data.calls || "";
            document.getElementById('numMeetings').value = data.meetings || "";
            document.getElementById('a_ulp').checked = data.a_ulp || false;
            document.getElementById('a_zero').checked = data.a_zero || false;
            document.getElementById('numPV').value = data.pv || "";
            document.getElementById('s_diamond').checked = data.s_diamond || false;
            document.getElementById('s_online').checked = data.s_online || false;
            document.getElementById('s_billing').checked = data.s_billing || false;
            document.getElementById('e_learn').checked = data.e_learn || false;
            document.getElementById('e_book').checked = data.e_book || false;
            document.getElementById('e_teach').checked = data.e_teach || false;
            document.getElementById('so_relation').checked = data.so_relation || false;
            document.getElementById('so_forgive').checked = data.so_forgive || false;
            document.getElementById('so_health').checked = data.so_health || false;
            
            // Load Plans List
            if (data.plansList && Array.isArray(data.plansList)) {
                data.plansList.forEach(text => window.addPlanField(text));
            } else {
                window.addPlanField(); // Add one empty
            }

        } else {
            document.getElementById('trackerForm').reset();
            document.getElementById('totalToday').value = "";
            document.getElementById('legAToday').value = "";
            document.getElementById('legBToday').value = "";
            window.addPlanField(); // Add one empty
        }

        const yestRef = doc(db, "rcm_marathi_tracker", yestVal);
        const yestSnap = await getDoc(yestRef);
        
        if (yestSnap.exists()) {
            const yData = yestSnap.data();
            document.getElementById('totalYest').value = yData.totalToday || 0;
            document.getElementById('legAYest').value = yData.legAToday || 0;
            document.getElementById('legBYest').value = yData.legBToday || 0;
        } else {
            document.getElementById('totalYest').value = 0;
            document.getElementById('legAYest').value = 0;
            document.getElementById('legBYest').value = 0;
        }

        window.calcGrowth();

    } catch (error) {
        console.error(error);
    } finally {
        loadingMsg.style.display = 'none';
    }
  }

  document.getElementById('btnSaveData').addEventListener('click', window.saveToFirebase);
  document.getElementById('btnLoad').addEventListener('click', window.loadFromFirebase);
  document.getElementById('reportDate').addEventListener('change', window.loadFromFirebase);
</script>

<script>
    // DYNAMIC PLANS LOGIC
    window.addPlanField = function(value = "") {
        const container = document.getElementById('planContainer');
        const div = document.createElement('div');
        div.className = 'plan-row';
        div.innerHTML = `
            <input type="text" class="plan-input dynamic-plan" value="${value}" placeholder="‡§Ø‡•á‡§•‡•á ‡§ï‡§æ‡§Æ ‡§≤‡§ø‡§π‡§æ...">
            <button type="button" class="btn-remove-plan" onclick="this.parentElement.remove()">X</button>
        `;
        container.appendChild(div);
    }

    // Countdown
    function updateCountdown() {
        const targetDate = new Date("March 31, 2026 23:59:59").getTime();
        const now = new Date().getTime();
        const distance = targetDate - now;
        const days = Math.floor(distance / (1000 * 60 * 60 * 24));
        document.getElementById("countdownTimer").innerText = `üî• Mission March 2026: ‡§´‡§ï‡•ç‡§§ ${days} ‡§¶‡§ø‡§µ‡§∏ ‡§¨‡§æ‡§ï‡•Ä! üî•`;
    }

    // Growth Calc
    window.calcGrowth = function() {
        doCalc('totalToday', 'totalYest', 'gTotal');
        doCalc('legAToday', 'legAYest', 'gLegA');
        doCalc('legBToday', 'legBYest', 'gLegB');
    }

    function doCalc(tId, yId, resId) {
        let t = parseFloat(document.getElementById(tId).value) || 0;
        let y = parseFloat(document.getElementById(yId).value) || 0;
        let el = document.getElementById(resId);
        let diff = t - y;
        let sign = diff > 0 ? "+" : "";
        let color = diff >= 0 ? "pos" : "neg";
        if(y > 0) {
            let p = ((diff/y)*100).toFixed(1);
            el.innerHTML = `<span class="${color}">${sign}${diff} <br> (${sign}${p}%)</span>`;
        } else {
            el.innerHTML = t > 0 ? `<span class="pos">+${t}</span>` : "-";
        }
    }

    // Analysis
    document.getElementById('btnCalc').addEventListener('click', calculateAnalysis);
    document.getElementById('btnDownloadPDF').addEventListener('click', downloadPDF);

    function calculateAnalysis() {
        let score = 0;
        let plans = parseInt(document.getElementById('numPlan').value) || 0;
        let meetings = parseInt(document.getElementById('numMeetings').value) || 0;
        let calls = parseInt(document.getElementById('numCalls').value) || 0;
        let pv = parseInt(document.getElementById('numPV').value) || 0;
        
        let checkboxes = document.querySelectorAll('.track-check');
        let checkedCount = 0;
        checkboxes.forEach(box => { if(box.checked) checkedCount++; });
        score += (checkedCount * 3);
        score += Math.min(plans * 10, 30);
        score += Math.min(meetings * 15, 30);
        score += Math.min(calls * 2, 10);
        score += Math.min(pv / 100, 10);
        if(score > 100) score = 100;

        let feedback = `<strong>‡§§‡•Å‡§Æ‡§ö‡§æ ‡§∏‡•ç‡§ï‡•ã‡§∞: ${Math.round(score)}/100</strong><br>`;
        let legB = parseInt(document.getElementById('legBToday').value) || 0;
        let legBYest = parseInt(document.getElementById('legBYest').value) || 0;
        if(legB > legBYest) feedback += "üöÄ <strong>‡§™‡•ç‡§∞‡§ó‡§§‡•Ä:</strong> ‡§≤‡•á‡§ó B (‡§¶‡•Å‡§∏‡§∞‡§æ ‡§ó‡•ç‡§∞‡•Å‡§™) ‡§µ‡§æ‡§¢‡§§ ‡§Ü‡§π‡•á.<br>";
        if(plans === 0) feedback += "üî¥ <strong>‡§∏‡§æ‡§µ‡§ß‡§æ‡§®:</strong> ‡§Ü‡§ú ‡§è‡§ï‡§π‡•Ä ‡§™‡•ç‡§≤‡§æ‡§® ‡§¶‡§æ‡§ñ‡§µ‡§≤‡§æ ‡§®‡§æ‡§π‡•Ä.<br>";

        document.getElementById('analysisText').innerHTML = feedback;
        document.getElementById('resultArea').style.display = 'block';
        return score;
    }

    // WhatsApp Share (Dynamic Tasks Included)
    window.shareToWhatsApp = function() {
        let score = calculateAnalysis() || 0;
        let date = document.getElementById('reportDate').value;
        let total = document.getElementById('totalToday').value || 0;
        let legA = document.getElementById('legAToday').value || 0;
        let legB = document.getElementById('legBToday').value || 0;
        
        // Get Tasks
        let tasks = "";
        let inputs = document.querySelectorAll('.dynamic-plan');
        inputs.forEach((inp, index) => {
            if(inp.value.trim() !== "") {
                tasks += `${index + 1}. ${inp.value.trim()}%0a`;
            }
        });

        let text = `üáÆüá≥ *RCM Daily Report* (${date})%0a` +
                   `-----------------------------%0a` +
                   `üìä *Business:* ${total} PV%0a` +
                   `üü¢ Leg A: ${legA} | üü† Leg B: ${legB}%0a` +
                   `üèÜ *Daily Score:* ${Math.round(score)}/100%0a` +
                   `-----------------------------%0a` +
                   `üìù *Planning:*%0a` +
                   `${tasks}` +
                   `-----------------------------%0a` +
                   `üî• *Mission March 2026* üî•`;

        window.open(`https://wa.me/?text=${text}`, '_blank');
    }

    function downloadPDF() {
        calculateAnalysis();
        const element = document.getElementById('reportContent');
        const dateVal = document.getElementById('reportDate').value;
        const opt = {
            margin: 0.3,
            filename: `RCM_Report_${dateVal}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
        };
        html2pdf().set(opt).from(element).save();
    }
</script>

</body>
</html>
